
<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="theme-color" content="#2a7a64">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js");
      });
    }
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>💚 Heart-Healthy Dinners & Grocery List</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .main-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .meal-card {
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .meal-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }
    
    .meal-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    
    .grocery-card {
      background: linear-gradient(145deg, #f0fff4, #e6fffa);
      border-left: 4px solid #48bb78;
      border-radius: 16px;
    }
    
    .btn-gradient-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
    }
    
    .btn-gradient-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      color: white;
    }
    
    .btn-gradient-danger {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      border: none;
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
    }
    
    .btn-gradient-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
      color: white;
    }
    
    .btn-gradient-success {
      background: linear-gradient(135deg, #48bb78, #38a169);
      border: none;
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(72, 187, 120, 0.3);
    }
    
    .btn-gradient-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
      color: white;
    }
    
    .grocery-item {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
      touch-action: manipulation;
    }
    
    .grocery-item:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .grocery-item.checked {
      opacity: 0.6;
      background: #f0fff4;
    }
    
    .grocery-item.checked label {
      text-decoration: line-through;
      color: #68d391;
    }
    
    .grocery-item input[type="checkbox"] {
      transform: scale(1.5);
      accent-color: #48bb78;
    }
    
    .remove-btn {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }
    
    .remove-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
    }
    
    .grocery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 0.75rem;
      max-height: 60vh;
      overflow-y: auto;
    }
    
    @media (max-width: 576px) {
      .grocery-grid {
        grid-template-columns: 1fr;
        max-height: 50vh;
      }
      
      .grocery-item input[type="checkbox"] {
        transform: scale(1.8);
      }
    }
    </style>


</head>
<body>
  <div class="container-fluid py-3">
    <div class="container main-container p-4">
      <h1 class="text-center gradient-text fw-bold mb-2">💚 Heart-Healthy Dinners</h1>
      <p class="text-center text-muted fs-5 mb-4">Delicious, nutritious meals without fish or onions</p>

      <div class="row justify-content-center mb-4">
        <div class="col-md-6 col-lg-4 mb-3">
          <label for="recipe-count" class="form-label fw-medium">Show recipes:</label>
          <select id="recipe-count" onchange="updateRecipeDisplay()" class="form-select">
            <option value="3">3 recipes</option>
            <option value="5" selected>5 recipes</option>
            <option value="7">7 recipes</option>
            <option value="10">All recipes</option>
          </select>
        </div>
        <div class="col-md-6 col-lg-4 mb-3">
          <label for="serving-size" class="form-label fw-medium">Serving size:</label>
          <select id="serving-size" onchange="updateServingSizes()" class="form-select">
            <option value="1">1 person</option>
            <option value="2">2 people</option>
            <option value="3">3 people</option>
            <option value="4" selected>4 people</option>
            <option value="6">6 people</option>
            <option value="8">8 people</option>
          </select>
        </div>
      </div>

      <div id="meals-container" class="mb-5">
        <!-- Meals will be loaded here by JavaScript -->
      </div>

      <div class="card grocery-card">
        <div class="card-header">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <h2 class="mb-0">🛒 Grocery List</h2>
            <div class="d-flex flex-wrap gap-2">
              <button id="clear-checked" onclick="clearCheckedItems()" class="btn btn-gradient-primary btn-sm">Clear Checked</button>
              <button id="toggle-all" onclick="toggleAllItems()" class="btn btn-gradient-primary btn-sm">Check All</button>
              <button id="hide-checked" onclick="toggleHideChecked()" class="btn btn-gradient-primary btn-sm">Hide Checked</button>
              <button onclick="clearAllData()" class="btn btn-gradient-danger btn-sm">Clear All Data</button>
            </div>
          </div>
          <div class="d-flex flex-wrap gap-2 mt-3 justify-content-center">
            <button onclick="sortGroceryList('produce')" class="btn btn-gradient-success btn-sm">🥬 Produce</button>
            <button onclick="sortGroceryList('pantry')" class="btn btn-warning btn-sm">🥫 Pantry</button>
            <button onclick="sortGroceryList('dairy')" class="btn btn-info btn-sm">🥛 Dairy</button>
            <button onclick="sortGroceryList('meat')" class="btn btn-gradient-danger btn-sm">🥩 Meat</button>
            <button onclick="sortGroceryList('alphabetical')" class="btn btn-secondary btn-sm">🔤 A-Z</button>
          </div>
        </div>
        
        <div class="card-body">
          <div class="row mb-3">
            <div class="col">
              <div class="input-group">
                <input type="text" id="new-item" class="form-control" placeholder="Add grocery item..." onkeypress="handleAddKeyPress(event)">
                <button onclick="addItem()" class="btn btn-gradient-success">+ Add</button>
              </div>
            </div>
          </div>
          
          <div class="text-center mb-3">
            <span id="grocery-stats" class="badge bg-secondary fs-6">0 items • 0 checked</span>
          </div>
          
          <div id="grocery-list" class="grocery-grid">
            <!-- Items will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script src="recipes.js"></script>
  <script>
    function toggleInstructions(button) {
      const mealDiv = button.closest('.meal');
      const instructionsDiv = mealDiv.querySelector('.instructions');
      if (instructionsDiv.style.display === "block") {
        instructionsDiv.style.display = "none";
        button.textContent = "View Instructions";
      } else {
        instructionsDiv.style.display = "block";
        button.textContent = "Hide Instructions";
      }
    }
  
    function addItem() {
      const input = document.getElementById('new-item');
      const value = input.value.trim();
      if (value) {
        const groceryList = document.getElementById('grocery-list');
        const existingItems = Array.from(groceryList.querySelectorAll('.grocery-item'));
        const baseName = value.toLowerCase();
        
        // Find and remove existing items with the same base name
        let maxCount = 0;
        const itemsToRemove = [];
        
        existingItems.forEach(item => {
          const label = item.querySelector('label');
          const labelText = label.textContent;
          const labelLower = labelText.toLowerCase();
          
          // Check if this item matches the base name
          if (labelLower === baseName || labelLower.startsWith(baseName + ' (')) {
            itemsToRemove.push(item);
            
            // Extract count from existing item
            const match = labelText.match(/\((\d+)\)$/);
            if (match) {
              maxCount = Math.max(maxCount, parseInt(match[1]));
            } else if (labelLower === baseName) {
              maxCount = Math.max(maxCount, 1);
            }
          }
        });
        
        // Remove existing items
        itemsToRemove.forEach(item => item.remove());
        
        // Create new item with incremented count
        const div = document.createElement('div');
        div.className = 'grocery-item p-3 d-flex align-items-center';
        const newCount = maxCount + 1;
        const displayValue = newCount > 1 ? `${value} (${newCount})` : value;
      
        div.innerHTML = `
          <input type="checkbox" class="form-check-input me-3" onchange="updateGroceryStats(); saveState();">
          <label class="flex-grow-1 mb-0" onclick="toggleCheckbox(this)">${displayValue}</label>
          <button class="remove-btn ms-2" onclick="removeItem(this)">✕</button>
        `;
        groceryList.appendChild(div);
        input.value = '';
        updateGroceryStats();
        saveState();
      }
    }

    function removeItem(button) {
      const item = button.parentElement;
      item.style.transform = 'translateX(100%)';
      item.style.opacity = '0';
      setTimeout(() => {
        item.remove();
        updateGroceryStats();
        saveState();
      }, 300);
    }

    function handleAddKeyPress(event) {
      if (event.key === 'Enter') {
        addItem();
      }
    }

    function toggleCheckbox(label) {
      const checkbox = label.parentElement.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      const item = checkbox.parentElement;
      item.classList.toggle('checked', checkbox.checked);
      
      // Handle hide/show logic
      if (hideCheckedItems && checkbox.checked) {
        item.style.display = 'none';
      } else if (!hideCheckedItems) {
        item.style.display = 'flex';
      }
      
      updateGroceryStats();
      saveState();
    }

    function clearCheckedItems() {
      const checkedItems = document.querySelectorAll('.grocery-item input[type="checkbox"]:checked');
      checkedItems.forEach(checkbox => {
        const item = checkbox.parentElement;
        item.style.transform = 'translateX(100%)';
        item.style.opacity = '0';
        setTimeout(() => item.remove(), 300);
      });
      setTimeout(() => {
        updateGroceryStats();
        saveState();
      }, 350);
    }

    function toggleAllItems() {
      const checkboxes = document.querySelectorAll('.grocery-item input[type="checkbox"]');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
        const item = checkbox.parentElement;
        item.classList.toggle('checked', checkbox.checked);
        
        // Handle hide/show logic
        if (hideCheckedItems && checkbox.checked) {
          item.style.display = 'none';
        } else if (!hideCheckedItems) {
          item.style.display = 'flex';
        }
      });
      updateGroceryStats();
      saveState();
    }

    function updateGroceryStats() {
      const allItems = document.querySelectorAll('.grocery-item');
      const checkedItems = document.querySelectorAll('.grocery-item input[type="checkbox"]:checked');
      const statsElement = document.getElementById('grocery-stats');
      
      if (statsElement) {
        statsElement.textContent = `${allItems.length} items • ${checkedItems.length} checked`;
      }
    }

    function swapRecipe(button) {
      const mealDiv = button.closest('.meal');
      const currentMealId = parseInt(mealDiv.dataset.mealId);
      
      // Find available recipes that aren't currently displayed
      const availableRecipes = recipes.filter(recipe => 
        !currentlyDisplayedRecipes.includes(recipe.id) || recipe.id === currentMealId
      );
      
      // If we only have the current recipe available, don't swap
      if (availableRecipes.length <= 1) {
        alert('No other recipes available to swap!');
        return;
      }
      
      // Get a random recipe from available ones (excluding current)
      const availableIds = availableRecipes.filter(recipe => recipe.id !== currentMealId);
      const randomIndex = Math.floor(Math.random() * availableIds.length);
      const newRecipe = availableIds[randomIndex];
      
      // Update the currently displayed recipes array
      const currentIndex = currentlyDisplayedRecipes.indexOf(currentMealId);
      if (currentIndex !== -1) {
        currentlyDisplayedRecipes[currentIndex] = newRecipe.id;
      }
      
      // Update the meal div with new recipe
      mealDiv.dataset.mealId = newRecipe.id;
      updateRecipe(mealDiv, newRecipe);
      updateShoppingList();
      saveState();
    }

    function updateRecipe(mealDiv, recipe) {
      // Update title
      mealDiv.querySelector('h2').textContent = recipe.title;
      
      // Get current serving size
      const servingSize = parseInt(document.getElementById('serving-size').value);
      const originalServings = parseInt(recipe.servings.split(' ')[0]); // Extract number from "4 servings"
      const scaleFactor = servingSize / originalServings;
      
      // Scale ingredients
      const scaledIngredients = recipe.ingredients.map(ingredient => scaleIngredient(ingredient, scaleFactor));
      
      // Update instructions div with detailed content
      const instructionsDiv = mealDiv.querySelector('.instructions');
      instructionsDiv.innerHTML = `
        <div style="display: grid; gap: 1rem; margin-bottom: 1rem;">
          <div style="display: flex; gap: 1rem; font-size: 0.9rem; color: #666;">
            <span>⏱️ Prep: ${recipe.prepTime}</span>
            <span>🍳 Cook: ${recipe.cookTime}</span>
            <span>🍽️ Serves: ${servingSize} ${servingSize === 1 ? 'person' : 'people'}</span>
          </div>
          <div style="background: #e6fffa; padding: 0.8rem; border-radius: 8px; font-size: 0.9rem; color: #2d5a4a;">
            <strong>💚 Heart-Healthy:</strong> ${recipe.healthNote}
          </div>
        </div>
        
        <div style="display: grid; gap: 1rem; grid-template-columns: 1fr 1fr;">
          <div>
            <h4 style="margin: 0 0 0.5rem 0; color: #4a5568;">Ingredients:</h4>
            <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.9rem;">
              ${scaledIngredients.map(ing => `<li style="margin-bottom: 0.3rem;">${ing}</li>`).join('')}
            </ul>
          </div>
          
          <div>
            <h4 style="margin: 0 0 0.5rem 0; color: #4a5568;">Instructions:</h4>
            <ol style="margin: 0; padding-left: 1.2rem; font-size: 0.9rem;">
              ${recipe.instructions.map(inst => `<li style="margin-bottom: 0.5rem; line-height: 1.4;">${inst}</li>`).join('')}
            </ol>
          </div>
        </div>
        
        <div style="margin-top: 1rem; padding: 0.8rem; background: #fff3cd; border-radius: 8px; font-size: 0.9rem;">
          <strong>📺 Find video tutorials:</strong> 
          <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(recipe.youtubeSearch)}" 
             target="_blank" 
             style="color: #d69e2e; text-decoration: none; margin-left: 0.5rem;">
            Search "${recipe.youtubeSearch}" on YouTube →
          </a>
        </div>
      `;
    }

    let currentlyDisplayedRecipes = [];

    function loadRecipes() {
      const recipeCount = parseInt(document.getElementById('recipe-count').value);
      const mealsContainer = document.getElementById('meals-container');
      
      // Clear existing meals
      mealsContainer.innerHTML = '';
      currentlyDisplayedRecipes = [];
      
      // Get random recipes to display
      const recipesToShow = getRandomRecipes(recipeCount);
      
      recipesToShow.forEach(recipe => {
        const mealDiv = document.createElement('div');
        mealDiv.className = 'mb-4';
        mealDiv.dataset.mealId = recipe.id;
        
        mealDiv.innerHTML = `
          <div class="card meal-card">
            <div class="card-body">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-3">
                <h2 class="card-title mb-2 mb-md-0 flex-grow-1">${recipe.title}</h2>
                <select onchange="swapToSpecificRecipe(this)" class="form-select" style="max-width: 200px;">
                  <option value="">Swap to...</option>
                  ${getAvailableRecipesForDropdown(recipe.id).map(r => `<option value="${r.id}">${r.title}</option>`).join('')}
                </select>
              </div>
              <div class="d-flex flex-column flex-sm-row gap-2">
                <button class="btn btn-gradient-primary" onclick="toggleInstructions(this)">View Instructions</button>
                <button class="btn btn-gradient-danger" onclick="swapRecipe(this)">Random Swap</button>
                <button class="btn btn-danger" onclick="searchYouTube('${recipe.youtubeSearch}')">📺 YouTube</button>
              </div>
              <div class="instructions mt-3" style="display: none;">
                <!-- Instructions will be populated by updateRecipe -->
              </div>
            </div>
          </div>
        `;
        
        mealsContainer.appendChild(mealDiv);
        updateRecipe(mealDiv, recipe);
        currentlyDisplayedRecipes.push(recipe.id);
      });
    }

    function getRandomRecipes(count) {
      if (count >= recipes.length) {
        return [...recipes];
      }
      
      const shuffled = [...recipes].sort(() => 0.5 - Math.random());
      return shuffled.slice(0, count);
    }

    function updateRecipeDisplay() {
      loadRecipes();
      updateShoppingList();
      saveState();
    }

    function updateShoppingList() {
      const groceryList = document.getElementById('grocery-list');
      const ingredientCounts = new Map();
      
      // Get current serving size and scale factor
      const servingSize = parseInt(document.getElementById('serving-size').value);
      
      // Get all current recipes and count ingredients
      const meals = document.querySelectorAll('.meal');
      meals.forEach(meal => {
        const mealId = parseInt(meal.dataset.mealId);
        const recipe = recipes[mealId];
        if (recipe && recipe.ingredients) {
          const originalServings = parseInt(recipe.servings.split(' ')[0]);
          const scaleFactor = servingSize / originalServings;
          
          recipe.ingredients.forEach(ingredient => {
            // Scale the ingredient first
            const scaledIngredient = scaleIngredient(ingredient, scaleFactor);
            // Normalize ingredient name (remove quantities for grouping)
            const normalizedIngredient = normalizeIngredientName(scaledIngredient);
            const count = ingredientCounts.get(normalizedIngredient) || 0;
            ingredientCounts.set(normalizedIngredient, count + 1);
          });
        }
      });
      
      // Clear current grocery list (except the add item input)
      const existingItems = groceryList.querySelectorAll('.grocery-item');
      existingItems.forEach(item => item.remove());
      
      // Add all ingredients to grocery list with counts
      Array.from(ingredientCounts.entries())
        .sort(([a], [b]) => a.localeCompare(b))
        .forEach(([ingredient, count]) => {
          const div = document.createElement('div');
          div.className = 'grocery-item';
          const displayName = count > 1 ? `${ingredient} (${count})` : ingredient;
          div.innerHTML = `<input type="checkbox" onchange="updateGroceryStats()"><label onclick="toggleCheckbox(this)">${displayName}</label><button class="remove-btn" onclick="removeItem(this)">✕</button>`;
          groceryList.appendChild(div);
        });
      
      updateGroceryStats();
    }

    let hideCheckedItems = false;

    // State management functions
    function saveState() {
      const state = {
        currentlyDisplayedRecipes: currentlyDisplayedRecipes,
        recipeCount: document.getElementById('recipe-count').value,
        servingSize: document.getElementById('serving-size').value,
        hideCheckedItems: hideCheckedItems,
        groceryItems: Array.from(document.querySelectorAll('.grocery-item')).map(item => ({
          text: item.querySelector('label').textContent,
          checked: item.querySelector('input[type="checkbox"]').checked
        }))
      };
      localStorage.setItem('heartHealthyDinnersState', JSON.stringify(state));
    }

    function loadState() {
      try {
        const savedState = localStorage.getItem('heartHealthyDinnersState');
        if (savedState) {
          const state = JSON.parse(savedState);
          
          // Restore recipe count selection
          if (state.recipeCount) {
            document.getElementById('recipe-count').value = state.recipeCount;
          }
          
          // Restore serving size selection
          if (state.servingSize) {
            document.getElementById('serving-size').value = state.servingSize;
          }
          
          // Restore hide checked items preference
          if (state.hideCheckedItems) {
            hideCheckedItems = state.hideCheckedItems;
            const button = document.getElementById('hide-checked');
            if (hideCheckedItems) {
              button.textContent = 'Show Checked';
            }
          }
          
          // Restore displayed recipes if they exist
          if (state.currentlyDisplayedRecipes && state.currentlyDisplayedRecipes.length > 0) {
            currentlyDisplayedRecipes = state.currentlyDisplayedRecipes;
            loadSpecificRecipes(currentlyDisplayedRecipes);
          } else {
            loadRecipes();
          }
          
          // Restore grocery items
          if (state.groceryItems && state.groceryItems.length > 0) {
            const groceryList = document.getElementById('grocery-list');
            // Clear auto-generated items first
            const existingItems = groceryList.querySelectorAll('.grocery-item');
            existingItems.forEach(item => item.remove());
            
            // Add saved items
            state.groceryItems.forEach(itemData => {
              const div = document.createElement('div');
              div.className = 'grocery-item';
              if (itemData.checked) {
                div.classList.add('checked');
              }
              div.innerHTML = `
                <input type="checkbox" class="form-check-input me-3" ${itemData.checked ? 'checked' : ''} onchange="updateGroceryStats(); saveState();">
                <label class="flex-grow-1 mb-0" onclick="toggleCheckbox(this)">${itemData.text}</label>
                <button class="remove-btn ms-2" onclick="removeItem(this)">✕</button>
              `;
              
              // Apply hide/show logic
              if (hideCheckedItems && itemData.checked) {
                div.style.display = 'none';
              }
              
              groceryList.appendChild(div);
            });
          } else {
            updateShoppingList();
          }
          
          updateGroceryStats();
          return true;
        }
      } catch (error) {
        console.error('Error loading saved state:', error);
      }
      return false;
    }

    function loadSpecificRecipes(recipeIds) {
      const mealsContainer = document.getElementById('meals-container');
      mealsContainer.innerHTML = '';
      
      recipeIds.forEach(recipeId => {
        const recipe = recipes.find(r => r.id === recipeId);
        if (recipe) {
          const mealDiv = document.createElement('div');
          mealDiv.className = 'mb-4';
          mealDiv.dataset.mealId = recipe.id;
          
          mealDiv.innerHTML = `
            <div class="card meal-card">
              <div class="card-body">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-3">
                  <h2 class="card-title mb-2 mb-md-0 flex-grow-1">${recipe.title}</h2>
                  <select onchange="swapToSpecificRecipe(this)" class="form-select" style="max-width: 200px;">
                    <option value="">Swap to...</option>
                    ${recipes.map(r => r.id !== recipe.id ? `<option value="${r.id}">${r.title}</option>` : '').join('')}
                  </select>
                </div>
                <div class="d-flex flex-column flex-sm-row gap-2">
                  <button class="btn btn-gradient-primary" onclick="toggleInstructions(this)">View Instructions</button>
                  <button class="btn btn-gradient-danger" onclick="swapRecipe(this)">Random Swap</button>
                  <button class="btn btn-danger" onclick="searchYouTube('${recipe.youtubeSearch}')">📺 YouTube</button>
                </div>
                <div class="instructions mt-3" style="display: none;">
                  <!-- Instructions will be populated by updateRecipe -->
                </div>
              </div>
            </div>
          `;
          
          mealsContainer.appendChild(mealDiv);
          updateRecipe(mealDiv, recipe);
        }
      });
    }

    function clearAllData() {
      if (confirm('This will clear all your saved recipes and grocery list. Are you sure?')) {
        localStorage.removeItem('heartHealthyDinnersState');
        location.reload();
      }
    }

    function scaleIngredient(ingredient, scaleFactor) {
      // Handle fractions and mixed numbers
      const fractionRegex = /(\d+)?\s*(\d+)\/(\d+)/;
      const numberRegex = /^(\d+(?:\.\d+)?)/;
      
      // Try to find and scale fractions first
      const fractionMatch = ingredient.match(fractionRegex);
      if (fractionMatch) {
        const wholeNumber = fractionMatch[1] ? parseInt(fractionMatch[1]) : 0;
        const numerator = parseInt(fractionMatch[2]);
        const denominator = parseInt(fractionMatch[3]);
        
        const originalValue = wholeNumber + (numerator / denominator);
        const scaledValue = originalValue * scaleFactor;
        
        // Convert back to fraction if reasonable
        const scaledFraction = decimalToFraction(scaledValue);
        return ingredient.replace(fractionMatch[0], scaledFraction);
      }
      
      // Try to find and scale regular numbers
      const numberMatch = ingredient.match(numberRegex);
      if (numberMatch) {
        const originalValue = parseFloat(numberMatch[1]);
        const scaledValue = originalValue * scaleFactor;
        
        // Always round up to whole number
        const roundedValue = Math.ceil(scaledValue);
        
        return ingredient.replace(numberMatch[1], roundedValue.toString());
      }
      
      return ingredient; // Return unchanged if no numbers found
    }

    function decimalToFraction(decimal) {
      // Always round up to whole number
      return Math.ceil(decimal).toString();
    }

    function updateServingSizes() {
      // Update all currently displayed recipes with new serving sizes
      const meals = document.querySelectorAll('.meal');
      meals.forEach(meal => {
        const mealId = parseInt(meal.dataset.mealId);
        const recipe = recipes.find(r => r.id === mealId);
        if (recipe) {
          updateRecipe(meal, recipe);
        }
      });
      
      // Update grocery list with scaled ingredients
      updateShoppingList();
      saveState();
    }

    function getAvailableRecipesForDropdown(currentRecipeId) {
      return recipes.filter(recipe => 
        !currentlyDisplayedRecipes.includes(recipe.id) || recipe.id === currentRecipeId
      ).filter(recipe => recipe.id !== currentRecipeId);
    }

    function searchYouTube(searchQuery) {
      const url = `https://www.youtube.com/results?search_query=${encodeURIComponent(searchQuery)}`;
      window.open(url, '_blank');
    }

    function swapToSpecificRecipe(selectElement) {
      const selectedRecipeId = parseInt(selectElement.value);
      if (!selectedRecipeId) return;
      
      const mealDiv = selectElement.closest('.meal');
      const currentMealId = parseInt(mealDiv.dataset.mealId);
      const newRecipe = recipes.find(r => r.id === selectedRecipeId);
      
      if (!newRecipe) return;
      
      // Update the currently displayed recipes array
      const currentIndex = currentlyDisplayedRecipes.indexOf(currentMealId);
      if (currentIndex !== -1) {
        currentlyDisplayedRecipes[currentIndex] = newRecipe.id;
      }
      
      // Update the meal div with new recipe
      mealDiv.dataset.mealId = newRecipe.id;
      updateRecipe(mealDiv, newRecipe);
      
      // Update ALL dropdowns to reflect the new state
      updateAllDropdowns();
      
      updateShoppingList();
      saveState();
    }

    function updateAllDropdowns() {
      const dropdowns = document.querySelectorAll('.recipe-swap-dropdown');
      dropdowns.forEach(dropdown => {
        const mealDiv = dropdown.closest('.meal');
        const currentRecipeId = parseInt(mealDiv.dataset.mealId);
        const availableRecipes = getAvailableRecipesForDropdown(currentRecipeId);
        
        dropdown.innerHTML = `
          <option value="">Swap to...</option>
          ${availableRecipes.map(r => `<option value="${r.id}">${r.title}</option>`).join('')}
        `;
      });
    }

    function normalizeIngredientName(ingredient) {
      // First scale the ingredient to round up quantities
      const scaledIngredient = scaleIngredient(ingredient, 1); // Scale by 1 to apply rounding
      
      // Remove common quantity indicators and normalize for grouping
      const normalized = scaledIngredient
        .replace(/^\d+(\s*\/\s*\d+)?\s*(cups?|tbsp|tsp|oz|lbs?|cans?|large|medium|small|boneless|skinless)\s*/i, '') // Handle fractions like 1/2, 1 1/2
        .replace(/^\d+(\s*\/\s*\d+)?\s*/, '') // Remove leading numbers and fractions
        .replace(/\s*\([^)]*\)/, '') // Remove parenthetical info
        .replace(/,.*$/, '') // Remove everything after comma
        .trim()
        .toLowerCase();
      
      // Return original ingredient if normalization results in empty string
      return normalized || scaledIngredient.trim();
    }

    function toggleHideChecked() {
      hideCheckedItems = !hideCheckedItems;
      const button = document.getElementById('hide-checked');
      const checkedItems = document.querySelectorAll('.grocery-item.checked');
      
      if (hideCheckedItems) {
        button.textContent = 'Show Checked';
        checkedItems.forEach(item => {
          item.style.display = 'none';
        });
      } else {
        button.textContent = 'Hide Checked';
        checkedItems.forEach(item => {
          item.style.display = 'flex';
        });
      }
      saveState();
    }

    function categorizeIngredient(ingredient) {
      const lowerIngredient = ingredient.toLowerCase();
      
      // Produce
      if (lowerIngredient.includes('tomato') || lowerIngredient.includes('pepper') || 
          lowerIngredient.includes('spinach') || lowerIngredient.includes('kale') ||
          lowerIngredient.includes('broccoli') || lowerIngredient.includes('carrot') ||
          lowerIngredient.includes('celery') || lowerIngredient.includes('cucumber') ||
          lowerIngredient.includes('zucchini') || lowerIngredient.includes('eggplant') ||
          lowerIngredient.includes('cabbage') || lowerIngredient.includes('avocado') ||
          lowerIngredient.includes('lemon') || lowerIngredient.includes('lime') ||
          lowerIngredient.includes('garlic') || lowerIngredient.includes('sweet potato') ||
          lowerIngredient.includes('mushroom') || lowerIngredient.includes('berry') ||
          lowerIngredient.includes('strawberry') || lowerIngredient.includes('blueberry') ||
          lowerIngredient.includes('banana') || lowerIngredient.includes('parsley') ||
          lowerIngredient.includes('cilantro') || lowerIngredient.includes('basil') ||
          lowerIngredient.includes('mint') || lowerIngredient.includes('greens')) {
        return 'produce';
      }
      
      // Dairy
      if (lowerIngredient.includes('milk') || lowerIngredient.includes('cheese') ||
          lowerIngredient.includes('yogurt') || lowerIngredient.includes('mozzarella') ||
          lowerIngredient.includes('parmesan')) {
        return 'dairy';
      }
      
      // Meat
      if (lowerIngredient.includes('chicken') || lowerIngredient.includes('turkey') ||
          lowerIngredient.includes('beef') || lowerIngredient.includes('pork') ||
          lowerIngredient.includes('fish') || lowerIngredient.includes('salmon')) {
        return 'meat';
      }
      
      // Pantry (default for grains, canned goods, spices, oils, etc.)
      return 'pantry';
    }

    function sortGroceryList(sortType) {
      const groceryList = document.getElementById('grocery-list');
      const items = Array.from(groceryList.querySelectorAll('.grocery-item'));
      
      if (items.length === 0) return;
      
      let sortedItems;
      
      if (sortType === 'alphabetical') {
        sortedItems = items.sort((a, b) => {
          const textA = a.querySelector('label').textContent.toLowerCase();
          const textB = b.querySelector('label').textContent.toLowerCase();
          return textA.localeCompare(textB);
        });
      } else {
        // Sort by category
        const categoryOrder = {
          'produce': 1,
          'dairy': 2,
          'meat': 3,
          'pantry': 4
        };
        
        sortedItems = items.sort((a, b) => {
          const textA = a.querySelector('label').textContent;
          const textB = b.querySelector('label').textContent;
          const categoryA = categorizeIngredient(textA);
          const categoryB = categorizeIngredient(textB);
          
          if (sortType === 'all') {
            // Sort by category first, then alphabetically within category
            if (categoryA !== categoryB) {
              return categoryOrder[categoryA] - categoryOrder[categoryB];
            }
            return textA.toLowerCase().localeCompare(textB.toLowerCase());
          } else if (sortType === categoryA && sortType === categoryB) {
            // Both items are in the requested category, sort alphabetically
            return textA.toLowerCase().localeCompare(textB.toLowerCase());
          } else if (sortType === categoryA) {
            // Item A is in requested category, put it first
            return -1;
          } else if (sortType === categoryB) {
            // Item B is in requested category, put it first
            return 1;
          } else {
            // Neither item is in requested category, maintain original order
            return 0;
          }
        });
      }
      
      // Remove all items and re-add them in sorted order
      items.forEach(item => item.remove());
      sortedItems.forEach(item => groceryList.appendChild(item));
    }

    // Load recipes when page loads
    window.addEventListener('load', () => {
      // Try to load saved state first
      const stateLoaded = loadState();
      
      // If no saved state, load default recipes
      if (!stateLoaded) {
        loadRecipes();
        updateShoppingList();
      }
      
      // Add event listeners for checkbox changes
      document.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox' && e.target.closest('.grocery-item')) {
          const item = e.target.parentElement;
          item.classList.toggle('checked', e.target.checked);
          
          // Handle hide/show logic
          if (hideCheckedItems && e.target.checked) {
            item.style.display = 'none';
          } else if (!hideCheckedItems) {
            item.style.display = 'flex';
          }
          
          saveState();
        }
      });
    });
    </script>


</body>
</html>
