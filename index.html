
<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="theme-color" content="#2a7a64">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js");
      });
    }
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>üíö Heart-Healthy Dinners & Grocery List</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .main-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .meal-card {
      background: linear-gradient(145deg, #ffffff, #f8fafc);
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .meal-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea, #764ba2);
    }
    
    .meal-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    
    .grocery-card {
      background: linear-gradient(145deg, #f0fff4, #e6fffa);
      border-left: 4px solid #48bb78;
      border-radius: 16px;
    }
    
    .btn-gradient-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
    }
    
    .btn-gradient-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      color: white;
    }
    
    .btn-gradient-danger {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      border: none;
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
    }
    
    .btn-gradient-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
      color: white;
    }
    
    .btn-gradient-success {
      background: linear-gradient(135deg, #48bb78, #38a169);
      border: none;
      color: white;
      transition: all 0.3s ease;
      box-shadow: 0 2px 10px rgba(72, 187, 120, 0.3);
    }
    
    .btn-gradient-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
      color: white;
    }
    
    .grocery-container {
      background: #f8fafc;
      border-radius: 20px;
      overflow: hidden;
    }
    
    .grocery-header-new {
      background: linear-gradient(135deg, #48bb78, #38a169);
      color: white;
      padding: 1.5rem;
      position: relative;
    }
    
    .shopping-mode-toggle {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      border-radius: 25px;
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      transition: all 0.3s ease;
    }
    
    .shopping-mode-toggle:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    .shopping-mode-toggle.active {
      background: white;
      color: #48bb78;
      border-color: white;
    }
    
    .progress-ring {
      width: 80px;
      height: 80px;
      margin: 0 auto 1rem;
    }
    
    .progress-ring-circle {
      stroke: rgba(255, 255, 255, 0.3);
      stroke-width: 4;
      fill: transparent;
      r: 35;
      cx: 40;
      cy: 40;
    }
    
    .progress-ring-progress {
      stroke: white;
      stroke-width: 4;
      fill: transparent;
      r: 35;
      cx: 40;
      cy: 40;
      stroke-dasharray: 220;
      stroke-dashoffset: 220;
      transition: stroke-dashoffset 0.5s ease;
      transform: rotate(-90deg);
      transform-origin: 40px 40px;
    }
    
    .smart-add-container {
      position: relative;
      margin: 1.5rem;
    }
    
    .smart-add-input {
      width: 100%;
      padding: 1rem 1rem 1rem 3rem;
      border: none;
      border-radius: 15px;
      font-size: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      background: white;
    }
    
    .smart-add-input:focus {
      outline: none;
      box-shadow: 0 4px 25px rgba(72, 187, 120, 0.3);
    }
    
    .add-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #48bb78;
      font-size: 1.2rem;
    }
    
    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border-radius: 15px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 0.5rem;
    }
    
    .suggestion-item {
      padding: 1rem;
      cursor: pointer;
      border-bottom: 1px solid #f1f5f9;
      transition: background 0.2s ease;
    }
    
    .suggestion-item:hover {
      background: #f8fafc;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .category-section {
      margin-bottom: 1.5rem;
    }
    
    .category-header {
      display: flex;
      align-items: center;
      padding: 1rem 1.5rem 0.5rem;
      font-weight: 600;
      color: #4a5568;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .category-icon {
      width: 24px;
      height: 24px;
      margin-right: 0.75rem;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }
    
    .category-produce .category-icon { background: #dcfce7; }
    .category-dairy .category-icon { background: #dbeafe; }
    .category-meat .category-icon { background: #fee2e2; }
    .category-pantry .category-icon { background: #fef3c7; }
    
    .category-items {
      padding: 0 1rem;
    }
    
    .grocery-item-new {
      background: white;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .grocery-item-new:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-1px);
    }
    
    .grocery-item-new.checked {
      background: #f0fdf4;
      opacity: 0.7;
    }
    
    .grocery-item-new.checked .item-content {
      text-decoration: line-through;
      color: #16a34a;
    }
    
    .grocery-item-new.shopping-mode {
      padding: 1.5rem;
      margin-bottom: 1rem;
      border-radius: 16px;
    }
    
    .item-main {
      display: flex;
      align-items: center;
      padding: 1rem;
      cursor: pointer;
    }
    
    .item-checkbox {
      width: 24px;
      height: 24px;
      margin-right: 1rem;
      accent-color: #16a34a;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .shopping-mode .item-checkbox {
      width: 32px;
      height: 32px;
      margin-right: 1.5rem;
    }
    
    .item-content {
      flex: 1;
      font-weight: 500;
      color: #1f2937;
      user-select: none;
    }
    
    .shopping-mode .item-content {
      font-size: 1.2rem;
      line-height: 1.4;
    }
    
    .item-quantity {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-right: 1rem;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .grocery-item-new:hover .item-quantity {
      opacity: 1;
    }
    
    .quantity-btn {
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 50%;
      background: #f1f5f9;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .quantity-btn:hover {
      background: #e2e8f0;
      color: #475569;
    }
    
    .quantity-display {
      min-width: 24px;
      text-align: center;
      font-weight: 600;
      color: #374151;
      font-size: 0.9rem;
    }
    
    .item-actions {
      display: flex;
      gap: 0.5rem;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .grocery-item-new:hover .item-actions {
      opacity: 1;
    }
    
    .action-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }
    
    .delete-btn {
      background: #fef2f2;
      color: #dc2626;
    }
    
    .delete-btn:hover {
      background: #fee2e2;
      transform: scale(1.1);
    }
    
    .swipe-actions {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      display: flex;
      align-items: center;
      background: #dc2626;
      color: white;
      padding: 0 1rem;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .grocery-item-new.swiped .swipe-actions {
      transform: translateX(0);
    }
    
    .quick-actions {
      display: flex;
      gap: 1rem;
      padding: 1rem 1.5rem;
      background: white;
      border-top: 1px solid #f1f5f9;
    }
    
    .quick-action-btn {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: white;
      color: #6b7280;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .quick-action-btn:hover {
      border-color: #48bb78;
      color: #48bb78;
      background: #f0fdf4;
    }
    
    .quick-action-btn.active {
      background: #48bb78;
      color: white;
      border-color: #48bb78;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem 1.5rem;
      color: #6b7280;
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    @media (max-width: 768px) {
      .grocery-header-new {
        padding: 1rem;
      }
      
      .shopping-mode-toggle {
        position: static;
        margin-top: 1rem;
        width: 100%;
      }
      
      .progress-ring {
        width: 60px;
        height: 60px;
      }
      
      .smart-add-container {
        margin: 1rem;
      }
      
      .item-quantity,
      .item-actions {
        opacity: 1;
      }
      
      .quick-actions {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      
      .quick-action-btn {
        min-width: calc(50% - 0.25rem);
      }
    }
    </style>


</head>
<body>
  <div class="container-fluid py-3">
    <div class="container main-container p-4">
      <h1 class="text-center gradient-text fw-bold mb-2">üíö Heart-Healthy Dinners</h1>
      <p class="text-center text-muted fs-5 mb-4">Delicious, nutritious meals without fish or onions</p>

      <div class="row justify-content-center mb-4">
        <div class="col-md-6 col-lg-4 mb-3">
          <label for="recipe-count" class="form-label fw-medium">Show recipes:</label>
          <select id="recipe-count" onchange="updateRecipeDisplay()" class="form-select">
            <option value="3">3 recipes</option>
            <option value="5" selected>5 recipes</option>
            <option value="7">7 recipes</option>
            <option value="10">All recipes</option>
          </select>
        </div>
        <div class="col-md-6 col-lg-4 mb-3">
          <label for="serving-size" class="form-label fw-medium">Serving size:</label>
          <select id="serving-size" onchange="updateServingSizes()" class="form-select">
            <option value="1">1 person</option>
            <option value="2">2 people</option>
            <option value="3">3 people</option>
            <option value="4" selected>4 people</option>
            <option value="6">6 people</option>
            <option value="8">8 people</option>
          </select>
        </div>
      </div>

      <div id="meals-container" class="mb-5">
        <!-- Meals will be loaded here by JavaScript -->
      </div>

      <div class="grocery-container">
        <div class="grocery-header-new">
          <button class="shopping-mode-toggle" onclick="toggleShoppingMode()" id="shopping-mode-btn">
            üõçÔ∏è Shopping Mode
          </button>
          
          <div class="text-center">
            <svg class="progress-ring">
              <circle class="progress-ring-circle"></circle>
              <circle class="progress-ring-progress" id="progress-circle"></circle>
            </svg>
            <h2 class="mb-2">üõí Smart Grocery List</h2>
            <div id="grocery-stats-new" class="fs-5 opacity-90">0 items ‚Ä¢ 0% complete</div>
          </div>
        </div>

        <div class="smart-add-container">
          <div class="position-relative">
            <i class="add-icon">+</i>
            <input 
              type="text" 
              id="smart-add-input" 
              class="smart-add-input" 
              placeholder="Add items to your list..."
              oninput="showSuggestions(this.value)"
              onkeypress="handleSmartAddKeyPress(event)"
              autocomplete="off"
            >
            <div id="suggestions-dropdown" class="suggestions-dropdown" style="display: none;"></div>
          </div>
        </div>

        <div id="grocery-categories" class="grocery-categories">
          <!-- Categories will be populated by JavaScript -->
        </div>

        <div class="quick-actions">
          <button class="quick-action-btn" onclick="toggleAllItemsNew()" id="toggle-all-btn">
            Check All
          </button>
          <button class="quick-action-btn" onclick="clearCheckedItemsNew()">
            Clear Done
          </button>
          <button class="quick-action-btn" onclick="toggleHideCheckedNew()" id="hide-checked-btn">
            Hide Done
          </button>
          <button class="quick-action-btn" onclick="clearAllDataNew()">
            Clear All
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script src="recipes.js"></script>
  <script>
    function toggleInstructions(button) {
      const mealDiv = button.closest('.card');
      const instructionsDiv = mealDiv.querySelector('.instructions');
      if (instructionsDiv.style.display === "block") {
        instructionsDiv.style.display = "none";
        button.textContent = "View Instructions";
      } else {
        instructionsDiv.style.display = "block";
        button.textContent = "Hide Instructions";
      }
    }
  
    const commonItems = [
      'Milk', 'Bread', 'Eggs', 'Butter', 'Cheese', 'Chicken breast', 'Ground turkey',
      'Bananas', 'Apples', 'Spinach', 'Tomatoes', 'Bell peppers', 'Carrots', 'Broccoli',
      'Rice', 'Pasta', 'Olive oil', 'Garlic', 'Sweet potatoes', 'Avocados', 'Yogurt',
      'Salmon', 'Quinoa', 'Black beans', 'Almonds', 'Blueberries', 'Lemon', 'Onions'
    ];

    let isShoppingMode = false;
    let hideCheckedItemsNew = false;

    function addItemNew(itemName, quantity = 1) {
      if (!itemName.trim()) return;
      
      const category = categorizeIngredient(itemName);
      const existingItem = findExistingItem(itemName);
      
      if (existingItem) {
        updateItemQuantity(existingItem, quantity);
      } else {
        createNewItem(itemName, quantity, category);
      }
      
      updateGroceryDisplayNew();
      updateGroceryStatsNew();
      saveState();
    }

    function createNewItem(name, quantity, category) {
      const item = {
        id: Date.now() + Math.random(),
        name: name.trim(),
        quantity: quantity,
        checked: false,
        category: category,
        manuallyAdded: true
      };
      
      if (!window.groceryItems) {
        window.groceryItems = [];
      }
      
      window.groceryItems.push(item);
    }

    function findExistingItem(name) {
      if (!window.groceryItems) return null;
      return window.groceryItems.find(item => 
        item.name.toLowerCase() === name.toLowerCase().trim()
      );
    }

    function updateItemQuantity(item, additionalQuantity) {
      item.quantity += additionalQuantity;
    }

    function showSuggestions(value) {
      const dropdown = document.getElementById('suggestions-dropdown');
      
      if (!value.trim()) {
        dropdown.style.display = 'none';
        return;
      }
      
      const suggestions = commonItems.filter(item => 
        item.toLowerCase().includes(value.toLowerCase()) &&
        !findExistingItem(item)
      ).slice(0, 5);
      
      if (suggestions.length === 0) {
        dropdown.style.display = 'none';
        return;
      }
      
      dropdown.innerHTML = suggestions.map(item => 
        `<div class="suggestion-item" onclick="selectSuggestion('${item}')">${item}</div>`
      ).join('');
      
      dropdown.style.display = 'block';
    }

    function selectSuggestion(item) {
      addItemNew(item);
      document.getElementById('smart-add-input').value = '';
      document.getElementById('suggestions-dropdown').style.display = 'none';
    }

    function handleSmartAddKeyPress(event) {
      if (event.key === 'Enter') {
        const input = event.target;
        addItemNew(input.value);
        input.value = '';
        document.getElementById('suggestions-dropdown').style.display = 'none';
      }
    }

    function removeItem(button) {
      const item = button.parentElement;
      item.style.transform = 'translateX(100%)';
      item.style.opacity = '0';
      setTimeout(() => {
        item.remove();
        updateGroceryStats();
        saveState();
      }, 300);
    }

    function handleAddKeyPress(event) {
      if (event.key === 'Enter') {
        addItem();
      }
    }

    function toggleCheckbox(label) {
      const checkbox = label.parentElement.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      const item = checkbox.parentElement;
      item.classList.toggle('checked', checkbox.checked);
      
      // Handle hide/show logic
      if (hideCheckedItems && checkbox.checked) {
        item.style.display = 'none';
      } else {
        item.style.display = 'flex';
      }
      
      updateGroceryStats();
      saveState();
    }

    function clearCheckedItems() {
      const checkedItems = document.querySelectorAll('.grocery-item input[type="checkbox"]:checked');
      checkedItems.forEach(checkbox => {
        const item = checkbox.parentElement;
        item.style.transform = 'translateX(100%)';
        item.style.opacity = '0';
        setTimeout(() => item.remove(), 300);
      });
      setTimeout(() => {
        updateGroceryStats();
        saveState();
      }, 350);
    }

    function toggleAllItems() {
      const checkboxes = document.querySelectorAll('.grocery-item input[type="checkbox"]');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = !allChecked;
        const item = checkbox.parentElement;
        item.classList.toggle('checked', checkbox.checked);
        
        // Handle hide/show logic
        if (hideCheckedItems && checkbox.checked) {
          item.style.display = 'none';
        } else {
          item.style.display = 'flex';
        }
      });
      updateGroceryStats();
      saveState();
    }

    function updateGroceryStatsNew() {
      if (!window.groceryItems) {
        window.groceryItems = [];
      }
      
      const totalItems = window.groceryItems.length;
      const checkedItems = window.groceryItems.filter(item => item.checked).length;
      const percentage = totalItems > 0 ? Math.round((checkedItems / totalItems) * 100) : 0;
      
      const statsElement = document.getElementById('grocery-stats-new');
      if (statsElement) {
        statsElement.textContent = `${totalItems} items ‚Ä¢ ${percentage}% complete`;
      }
      
      // Update progress ring
      const progressCircle = document.getElementById('progress-circle');
      if (progressCircle) {
        const circumference = 2 * Math.PI * 35; // radius = 35
        const offset = circumference - (percentage / 100) * circumference;
        progressCircle.style.strokeDashoffset = offset;
      }
    }

    function updateGroceryDisplayNew() {
      const container = document.getElementById('grocery-categories');
      if (!window.groceryItems) {
        window.groceryItems = [];
      }
      
      if (window.groceryItems.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üõí</div>
            <h3>Your list is empty</h3>
            <p>Add items above to get started</p>
          </div>
        `;
        return;
      }
      
      const categories = {
        produce: { name: 'Fresh Produce', icon: 'ü•¨', items: [] },
        dairy: { name: 'Dairy & Eggs', icon: 'ü•õ', items: [] },
        meat: { name: 'Meat & Seafood', icon: 'ü•©', items: [] },
        pantry: { name: 'Pantry & Dry Goods', icon: 'ü•´', items: [] }
      };
      
      // Group items by category
      window.groceryItems.forEach(item => {
        if (!hideCheckedItemsNew || !item.checked) {
          categories[item.category].items.push(item);
        }
      });
      
      // Render categories
      container.innerHTML = Object.entries(categories)
        .filter(([_, category]) => category.items.length > 0)
        .map(([key, category]) => `
          <div class="category-section category-${key}">
            <div class="category-header">
              <div class="category-icon">${category.icon}</div>
              ${category.name} (${category.items.length})
            </div>
            <div class="category-items">
              ${category.items.map(item => createItemHTML(item)).join('')}
            </div>
          </div>
        `).join('');
    }

    function createItemHTML(item) {
      const shoppingModeClass = isShoppingMode ? 'shopping-mode' : '';
      const checkedClass = item.checked ? 'checked' : '';
      
      return `
        <div class="grocery-item-new ${shoppingModeClass} ${checkedClass}" data-item-id="${item.id}">
          <div class="item-main" onclick="toggleItemCheck(${item.id})">
            <input type="checkbox" class="item-checkbox" ${item.checked ? 'checked' : ''} onchange="event.stopPropagation(); toggleItemCheck(${item.id})">
            <div class="item-content">${item.name}</div>
            <div class="item-quantity">
              <button class="quantity-btn" onclick="event.stopPropagation(); adjustQuantity(${item.id}, -1)">‚àí</button>
              <span class="quantity-display">${item.quantity}</span>
              <button class="quantity-btn" onclick="event.stopPropagation(); adjustQuantity(${item.id}, 1)">+</button>
            </div>
            <div class="item-actions">
              <button class="action-btn delete-btn" onclick="event.stopPropagation(); removeItemNew(${item.id})" aria-label="Remove ${item.name}">üóëÔ∏è</button>
            </div>
          </div>
        </div>
      `;
    }

    function toggleItemCheck(itemId) {
      const item = window.groceryItems.find(i => i.id === itemId);
      if (item) {
        item.checked = !item.checked;
        updateGroceryDisplayNew();
        updateGroceryStatsNew();
        saveState();
      }
    }

    function adjustQuantity(itemId, change) {
      const item = window.groceryItems.find(i => i.id === itemId);
      if (item) {
        item.quantity = Math.max(1, item.quantity + change);
        updateGroceryDisplayNew();
        saveState();
      }
    }

    function removeItemNew(itemId) {
      window.groceryItems = window.groceryItems.filter(item => item.id !== itemId);
      updateGroceryDisplayNew();
      updateGroceryStatsNew();
      saveState();
    }

    function toggleShoppingMode() {
      isShoppingMode = !isShoppingMode;
      const btn = document.getElementById('shopping-mode-btn');
      
      if (isShoppingMode) {
        btn.textContent = 'üìù Edit Mode';
        btn.classList.add('active');
      } else {
        btn.textContent = 'üõçÔ∏è Shopping Mode';
        btn.classList.remove('active');
      }
      
      updateGroceryDisplayNew();
      saveState();
    }

    function toggleAllItemsNew() {
      if (!window.groceryItems) return;
      
      const allChecked = window.groceryItems.every(item => item.checked);
      window.groceryItems.forEach(item => {
        item.checked = !allChecked;
      });
      
      const btn = document.getElementById('toggle-all-btn');
      btn.textContent = allChecked ? 'Check All' : 'Uncheck All';
      
      updateGroceryDisplayNew();
      updateGroceryStatsNew();
      saveState();
    }

    function clearCheckedItemsNew() {
      if (!window.groceryItems) return;
      
      window.groceryItems = window.groceryItems.filter(item => !item.checked);
      updateGroceryDisplayNew();
      updateGroceryStatsNew();
      saveState();
    }

    function toggleHideCheckedNew() {
      hideCheckedItemsNew = !hideCheckedItemsNew;
      const btn = document.getElementById('hide-checked-btn');
      btn.textContent = hideCheckedItemsNew ? 'Show Done' : 'Hide Done';
      btn.classList.toggle('active', hideCheckedItemsNew);
      
      updateGroceryDisplayNew();
      saveState();
    }

    function clearAllDataNew() {
      if (confirm('This will clear all your saved recipes and grocery list. Are you sure?')) {
        localStorage.removeItem('heartHealthyDinnersState');
        window.groceryItems = [];
        updateGroceryDisplayNew();
        updateGroceryStatsNew();
      }
    }

    function swapRecipe(button) {
      const mealDiv = button.closest('[data-meal-id]');
      const currentMealId = parseInt(mealDiv.dataset.mealId);
      
      // Find available recipes that aren't currently displayed
      const availableRecipes = recipes.filter(recipe => 
        recipe.id !== currentMealId && !currentlyDisplayedRecipes.includes(recipe.id)
      );
      
      // If no recipes available, don't swap
      if (availableRecipes.length === 0) {
        alert('No other recipes available to swap!');
        return;
      }
      
      // Get a random recipe from available ones
      const randomIndex = Math.floor(Math.random() * availableRecipes.length);
      const newRecipe = availableRecipes[randomIndex];
      
      // Update the currently displayed recipes array
      const currentIndex = currentlyDisplayedRecipes.indexOf(currentMealId);
      if (currentIndex !== -1) {
        currentlyDisplayedRecipes[currentIndex] = newRecipe.id;
      }
      
      // Update the meal div with new recipe
      mealDiv.dataset.mealId = newRecipe.id;
      updateRecipe(mealDiv, newRecipe);
      
      // Update all dropdowns to reflect the new state
      updateAllDropdowns();
      
      updateShoppingList();
      saveState();
    }

    function updateRecipe(mealDiv, recipe) {
      // Update title
      mealDiv.querySelector('h2').textContent = recipe.title;
      
      // Get current serving size
      const servingSize = parseInt(document.getElementById('serving-size').value);
      const originalServings = parseInt(recipe.servings.split(' ')[0]); // Extract number from "4 servings"
      const scaleFactor = servingSize / originalServings;
      
      // Scale ingredients
      const scaledIngredients = recipe.ingredients.map(ingredient => scaleIngredient(ingredient, scaleFactor));
      
      // Update instructions div with detailed content
      const instructionsDiv = mealDiv.querySelector('.instructions');
      instructionsDiv.innerHTML = `
        <div style="display: grid; gap: 1rem; margin-bottom: 1rem;">
          <div style="display: flex; gap: 1rem; font-size: 0.9rem; color: #666;">
            <span>‚è±Ô∏è Prep: ${recipe.prepTime}</span>
            <span>üç≥ Cook: ${recipe.cookTime}</span>
            <span>üçΩÔ∏è Serves: ${servingSize} ${servingSize === 1 ? 'person' : 'people'}</span>
          </div>
          <div style="background: #e6fffa; padding: 0.8rem; border-radius: 8px; font-size: 0.9rem; color: #2d5a4a;">
            <strong>üíö Heart-Healthy:</strong> ${recipe.healthNote}
          </div>
        </div>
        
        <div style="display: grid; gap: 1rem; grid-template-columns: 1fr 1fr;">
          <div>
            <h4 style="margin: 0 0 0.5rem 0; color: #4a5568;">Ingredients:</h4>
            <ul style="margin: 0; padding-left: 1.2rem; font-size: 0.9rem;">
              ${scaledIngredients.map(ing => `<li style="margin-bottom: 0.3rem;">${ing}</li>`).join('')}
            </ul>
          </div>
          
          <div>
            <h4 style="margin: 0 0 0.5rem 0; color: #4a5568;">Instructions:</h4>
            <ol style="margin: 0; padding-left: 1.2rem; font-size: 0.9rem;">
              ${recipe.instructions.map(inst => `<li style="margin-bottom: 0.5rem; line-height: 1.4;">${inst}</li>`).join('')}
            </ol>
          </div>
        </div>
        
        <div style="margin-top: 1rem; padding: 0.8rem; background: #fff3cd; border-radius: 8px; font-size: 0.9rem;">
          <strong>üì∫ Find video tutorials:</strong> 
          <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(recipe.youtubeSearch)}" 
             target="_blank" 
             style="color: #d69e2e; text-decoration: none; margin-left: 0.5rem;">
            Search "${recipe.youtubeSearch}" on YouTube ‚Üí
          </a>
        </div>
      `;
    }

    let currentlyDisplayedRecipes = [];

    function loadRecipes() {
      const recipeCount = parseInt(document.getElementById('recipe-count').value);
      const mealsContainer = document.getElementById('meals-container');
      
      // Clear existing meals
      mealsContainer.innerHTML = '';
      currentlyDisplayedRecipes = [];
      
      // Get random recipes to display
      const recipesToShow = getRandomRecipes(recipeCount);
      
      recipesToShow.forEach(recipe => {
        const mealDiv = document.createElement('div');
        mealDiv.className = 'mb-4';
        mealDiv.dataset.mealId = recipe.id;
        
        mealDiv.innerHTML = `
          <div class="card meal-card">
            <div class="card-body">
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-3">
                <h2 class="card-title mb-2 mb-md-0 flex-grow-1">${recipe.title}</h2>
                <select onchange="swapToSpecificRecipe(this)" class="form-select" style="max-width: 200px;">
                  <option value="">Swap to...</option>
                  ${getAvailableRecipesForDropdown(recipe.id).map(r => `<option value="${r.id}">${r.title}</option>`).join('')}
                </select>
              </div>
              <div class="d-flex flex-column flex-sm-row gap-2">
                <button class="btn btn-gradient-primary" onclick="toggleInstructions(this)">View Instructions</button>
                <button class="btn btn-gradient-danger" onclick="swapRecipe(this)">Random Swap</button>
                <button class="btn btn-danger" onclick="searchYouTube('${recipe.youtubeSearch}')">üì∫ YouTube</button>
              </div>
              <div class="instructions mt-3" style="display: none;">
                <!-- Instructions will be populated by updateRecipe -->
              </div>
            </div>
          </div>
        `;
        
        mealsContainer.appendChild(mealDiv);
        updateRecipe(mealDiv, recipe);
        currentlyDisplayedRecipes.push(recipe.id);
      });
    }

    function getRandomRecipes(count) {
      if (count >= recipes.length) {
        return [...recipes];
      }
      
      const shuffled = [...recipes].sort(() => 0.5 - Math.random());
      return shuffled.slice(0, count);
    }

    function updateRecipeDisplay() {
      loadRecipes();
      updateShoppingList();
      saveState();
    }

    function updateShoppingList() {
      if (!window.groceryItems) {
        window.groceryItems = [];
      }
      
      const ingredientCounts = new Map();
      const servingSize = parseInt(document.getElementById('serving-size').value);
      
      // Get all current recipes and count ingredients
      const meals = document.querySelectorAll('[data-meal-id]');
      meals.forEach(meal => {
        const mealId = parseInt(meal.dataset.mealId);
        const recipe = recipes.find(r => r.id === mealId);
        if (recipe && recipe.ingredients) {
          const originalServings = parseInt(recipe.servings.split(' ')[0]);
          const scaleFactor = servingSize / originalServings;
          
          recipe.ingredients.forEach(ingredient => {
            const scaledIngredient = scaleIngredient(ingredient, scaleFactor);
            const normalizedIngredient = normalizeIngredientName(scaledIngredient);
            const count = ingredientCounts.get(normalizedIngredient) || 0;
            ingredientCounts.set(normalizedIngredient, count + 1);
          });
        }
      });
      
      // Update existing items or create new ones
      Array.from(ingredientCounts.entries()).forEach(([ingredient, count]) => {
        const existingItem = findExistingItem(ingredient);
        if (existingItem) {
          existingItem.quantity = count;
        } else {
          const newItem = {
            id: Date.now() + Math.random(),
            name: ingredient.trim(),
            quantity: count,
            checked: false,
            category: categorizeIngredient(ingredient),
            fromRecipe: true
          };
          window.groceryItems.push(newItem);
        }
      });
      
      // Remove items that are no longer in recipes (but keep manually added items)
      window.groceryItems = window.groceryItems.filter(item => {
        const normalizedName = normalizeIngredientName(item.name);
        return ingredientCounts.has(normalizedName) || item.manuallyAdded || !item.fromRecipe;
      });
      
      updateGroceryDisplayNew();
      updateGroceryStatsNew();
    }

    let hideCheckedItems = false;

    // State management functions
    function saveState() {
      const state = {
        currentlyDisplayedRecipes: currentlyDisplayedRecipes,
        recipeCount: document.getElementById('recipe-count').value,
        servingSize: document.getElementById('serving-size').value,
        hideCheckedItems: hideCheckedItemsNew,
        isShoppingMode: isShoppingMode,
        groceryItems: window.groceryItems || []
      };
      localStorage.setItem('heartHealthyDinnersState', JSON.stringify(state));
    }

    function loadState() {
      try {
        const savedState = localStorage.getItem('heartHealthyDinnersState');
        if (savedState) {
          const state = JSON.parse(savedState);
          
          // Restore recipe count selection
          if (state.recipeCount) {
            document.getElementById('recipe-count').value = state.recipeCount;
          }
          
          // Restore serving size selection
          if (state.servingSize) {
            document.getElementById('serving-size').value = state.servingSize;
          }
          
          // Restore hide checked items preference
          if (state.hideCheckedItems) {
            hideCheckedItemsNew = state.hideCheckedItems;
            const button = document.getElementById('hide-checked-btn');
            if (hideCheckedItemsNew) {
              button.textContent = 'Show Done';
              button.classList.add('active');
            }
          }
          
          // Restore shopping mode
          if (state.isShoppingMode) {
            isShoppingMode = state.isShoppingMode;
            const button = document.getElementById('shopping-mode-btn');
            if (isShoppingMode) {
              button.textContent = 'üìù Edit Mode';
              button.classList.add('active');
            }
          }
          
          // Restore displayed recipes if they exist
          if (state.currentlyDisplayedRecipes && state.currentlyDisplayedRecipes.length > 0) {
            currentlyDisplayedRecipes = state.currentlyDisplayedRecipes;
            loadSpecificRecipes(currentlyDisplayedRecipes);
          } else {
            loadRecipes();
          }
          
          // Restore grocery items
          if (state.groceryItems && state.groceryItems.length > 0) {
            window.groceryItems = state.groceryItems;
          } else {
            window.groceryItems = [];
            updateShoppingList();
          }
          
          updateGroceryDisplayNew();
          updateGroceryStatsNew();
          return true;
        }
      } catch (error) {
        console.error('Error loading saved state:', error);
      }
      return false;
    }

    function loadSpecificRecipes(recipeIds) {
      const mealsContainer = document.getElementById('meals-container');
      mealsContainer.innerHTML = '';
      
      recipeIds.forEach(recipeId => {
        const recipe = recipes.find(r => r.id === recipeId);
        if (recipe) {
          const mealDiv = document.createElement('div');
          mealDiv.className = 'mb-4';
          mealDiv.dataset.mealId = recipe.id;
          
          mealDiv.innerHTML = `
            <div class="card meal-card">
              <div class="card-body">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-3">
                  <h2 class="card-title mb-2 mb-md-0 flex-grow-1">${recipe.title}</h2>
                  <select onchange="swapToSpecificRecipe(this)" class="form-select" style="max-width: 200px;">
                    <option value="">Swap to...</option>
                    ${recipes.map(r => r.id !== recipe.id ? `<option value="${r.id}">${r.title}</option>` : '').join('')}
                  </select>
                </div>
                <div class="d-flex flex-column flex-sm-row gap-2">
                  <button class="btn btn-gradient-primary" onclick="toggleInstructions(this)">View Instructions</button>
                  <button class="btn btn-gradient-danger" onclick="swapRecipe(this)">Random Swap</button>
                  <button class="btn btn-danger" onclick="searchYouTube('${recipe.youtubeSearch}')">üì∫ YouTube</button>
                </div>
                <div class="instructions mt-3" style="display: none;">
                  <!-- Instructions will be populated by updateRecipe -->
                </div>
              </div>
            </div>
          `;
          
          mealsContainer.appendChild(mealDiv);
          updateRecipe(mealDiv, recipe);
        }
      });
    }

    function clearAllData() {
      if (confirm('This will clear all your saved recipes and grocery list. Are you sure?')) {
        localStorage.removeItem('heartHealthyDinnersState');
        location.reload();
      }
    }

    function scaleIngredient(ingredient, scaleFactor) {
      // Handle fractions and mixed numbers
      const fractionRegex = /(\d+)?\s*(\d+)\/(\d+)/;
      const numberRegex = /^(\d+(?:\.\d+)?)/;
      
      // Try to find and scale fractions first
      const fractionMatch = ingredient.match(fractionRegex);
      if (fractionMatch) {
        const wholeNumber = fractionMatch[1] ? parseInt(fractionMatch[1]) : 0;
        const numerator = parseInt(fractionMatch[2]);
        const denominator = parseInt(fractionMatch[3]);
        
        const originalValue = wholeNumber + (numerator / denominator);
        const scaledValue = originalValue * scaleFactor;
        
        // Convert back to fraction if reasonable
        const scaledFraction = decimalToFraction(scaledValue);
        return ingredient.replace(fractionMatch[0], scaledFraction);
      }
      
      // Try to find and scale regular numbers
      const numberMatch = ingredient.match(numberRegex);
      if (numberMatch) {
        const originalValue = parseFloat(numberMatch[1]);
        const scaledValue = originalValue * scaleFactor;
        
        // Always round up to whole number
        const roundedValue = Math.ceil(scaledValue);
        
        return ingredient.replace(numberMatch[1], roundedValue.toString());
      }
      
      return ingredient; // Return unchanged if no numbers found
    }

    function decimalToFraction(decimal) {
      // Always round up to whole number
      return Math.ceil(decimal).toString();
    }

    function updateServingSizes() {
      // Update all currently displayed recipes with new serving sizes
      const meals = document.querySelectorAll('[data-meal-id]');
      meals.forEach(meal => {
        const mealId = parseInt(meal.dataset.mealId);
        const recipe = recipes.find(r => r.id === mealId);
        if (recipe) {
          updateRecipe(meal, recipe);
        }
      });
      
      // Update grocery list with scaled ingredients
      updateShoppingList();
      saveState();
    }

    function getAvailableRecipesForDropdown(currentRecipeId) {
      return recipes.filter(recipe => 
        recipe.id !== currentRecipeId && !currentlyDisplayedRecipes.includes(recipe.id)
      );
    }

    function searchYouTube(searchQuery) {
      const url = `https://www.youtube.com/results?search_query=${encodeURIComponent(searchQuery)}`;
      window.open(url, '_blank');
    }

    function swapToSpecificRecipe(selectElement) {
      const selectedRecipeId = parseInt(selectElement.value);
      if (!selectedRecipeId) return;
      
      const mealDiv = selectElement.closest('[data-meal-id]');
      const currentMealId = parseInt(mealDiv.dataset.mealId);
      const newRecipe = recipes.find(r => r.id === selectedRecipeId);
      
      if (!newRecipe) return;
      
      // Update the currently displayed recipes array
      const currentIndex = currentlyDisplayedRecipes.indexOf(currentMealId);
      if (currentIndex !== -1) {
        currentlyDisplayedRecipes[currentIndex] = newRecipe.id;
      }
      
      // Update the meal div with new recipe
      mealDiv.dataset.mealId = newRecipe.id;
      updateRecipe(mealDiv, newRecipe);
      
      // Reset the dropdown to default state
      selectElement.value = "";
      
      // Update ALL dropdowns to reflect the new state
      updateAllDropdowns();
      
      updateShoppingList();
      saveState();
    }

    function updateAllDropdowns() {
      const dropdowns = document.querySelectorAll('select[onchange="swapToSpecificRecipe(this)"]');
      dropdowns.forEach(dropdown => {
        const mealDiv = dropdown.closest('[data-meal-id]');
        if (!mealDiv) return;
        const currentRecipeId = parseInt(mealDiv.dataset.mealId);
        const availableRecipes = getAvailableRecipesForDropdown(currentRecipeId);
        
        // Store current selection to preserve it if it's still valid
        const currentSelection = dropdown.value;
        
        dropdown.innerHTML = `
          <option value="">Swap to...</option>
          ${availableRecipes.map(r => `<option value="${r.id}">${r.title}</option>`).join('')}
        `;
        
        // Reset to default after updating options
        dropdown.value = "";
      });
    }

    function normalizeIngredientName(ingredient) {
      // First scale the ingredient to round up quantities
      const scaledIngredient = scaleIngredient(ingredient, 1); // Scale by 1 to apply rounding
      
      // Remove common quantity indicators and normalize for grouping
      const normalized = scaledIngredient
        .replace(/^\d+(\s*\/\s*\d+)?\s*(cups?|tbsp|tsp|oz|lbs?|cans?|large|medium|small|boneless|skinless)\s*/i, '') // Handle fractions like 1/2, 1 1/2
        .replace(/^\d+(\s*\/\s*\d+)?\s*/, '') // Remove leading numbers and fractions
        .replace(/\s*\([^)]*\)/, '') // Remove parenthetical info
        .replace(/,.*$/, '') // Remove everything after comma
        .trim()
        .toLowerCase();
      
      // Return original ingredient if normalization results in empty string
      return normalized || scaledIngredient.trim();
    }

    function toggleHideChecked() {
      hideCheckedItems = !hideCheckedItems;
      const button = document.getElementById('hide-checked');
      const checkedItems = document.querySelectorAll('.grocery-item.checked');
      
      if (hideCheckedItems) {
        button.textContent = 'Show Checked';
        checkedItems.forEach(item => {
          item.style.display = 'none';
        });
      } else {
        button.textContent = 'Hide Checked';
        checkedItems.forEach(item => {
          item.style.display = 'flex';
        });
      }
      saveState();
    }

    function categorizeIngredient(ingredient) {
      const lowerIngredient = ingredient.toLowerCase();
      
      // Produce
      if (lowerIngredient.includes('tomato') || lowerIngredient.includes('pepper') || 
          lowerIngredient.includes('spinach') || lowerIngredient.includes('kale') ||
          lowerIngredient.includes('broccoli') || lowerIngredient.includes('carrot') ||
          lowerIngredient.includes('celery') || lowerIngredient.includes('cucumber') ||
          lowerIngredient.includes('zucchini') || lowerIngredient.includes('eggplant') ||
          lowerIngredient.includes('cabbage') || lowerIngredient.includes('avocado') ||
          lowerIngredient.includes('lemon') || lowerIngredient.includes('lime') ||
          lowerIngredient.includes('garlic') || lowerIngredient.includes('sweet potato') ||
          lowerIngredient.includes('mushroom') || lowerIngredient.includes('berry') ||
          lowerIngredient.includes('strawberry') || lowerIngredient.includes('blueberry') ||
          lowerIngredient.includes('banana') || lowerIngredient.includes('parsley') ||
          lowerIngredient.includes('cilantro') || lowerIngredient.includes('basil') ||
          lowerIngredient.includes('mint') || lowerIngredient.includes('greens')) {
        return 'produce';
      }
      
      // Dairy
      if (lowerIngredient.includes('milk') || lowerIngredient.includes('cheese') ||
          lowerIngredient.includes('yogurt') || lowerIngredient.includes('mozzarella') ||
          lowerIngredient.includes('parmesan')) {
        return 'dairy';
      }
      
      // Meat
      if (lowerIngredient.includes('chicken') || lowerIngredient.includes('turkey') ||
          lowerIngredient.includes('beef') || lowerIngredient.includes('pork') ||
          lowerIngredient.includes('fish') || lowerIngredient.includes('salmon')) {
        return 'meat';
      }
      
      // Pantry (default for grains, canned goods, spices, oils, etc.)
      return 'pantry';
    }

    function sortGroceryList(sortType) {
      const groceryList = document.getElementById('grocery-list');
      const items = Array.from(groceryList.querySelectorAll('.grocery-item'));
      
      if (items.length === 0) return;
      
      let sortedItems;
      
      if (sortType === 'alphabetical') {
        sortedItems = items.sort((a, b) => {
          const textA = a.querySelector('label').textContent.toLowerCase();
          const textB = b.querySelector('label').textContent.toLowerCase();
          return textA.localeCompare(textB);
        });
      } else {
        // Sort by category
        const categoryOrder = {
          'produce': 1,
          'dairy': 2,
          'meat': 3,
          'pantry': 4
        };
        
        sortedItems = items.sort((a, b) => {
          const textA = a.querySelector('label').textContent;
          const textB = b.querySelector('label').textContent;
          const categoryA = categorizeIngredient(textA);
          const categoryB = categorizeIngredient(textB);
          
          if (sortType === 'all') {
            // Sort by category first, then alphabetically within category
            if (categoryA !== categoryB) {
              return categoryOrder[categoryA] - categoryOrder[categoryB];
            }
            return textA.toLowerCase().localeCompare(textB.toLowerCase());
          } else if (sortType === categoryA && sortType === categoryB) {
            // Both items are in the requested category, sort alphabetically
            return textA.toLowerCase().localeCompare(textB.toLowerCase());
          } else if (sortType === categoryA) {
            // Item A is in requested category, put it first
            return -1;
          } else if (sortType === categoryB) {
            // Item B is in requested category, put it first
            return 1;
          } else {
            // Neither item is in requested category, maintain original order
            return 0;
          }
        });
      }
      
      // Remove all items and re-add them in sorted order
      items.forEach(item => item.remove());
      sortedItems.forEach(item => groceryList.appendChild(item));
    }

    // Load recipes when page loads
    window.addEventListener('load', () => {
      // Try to load saved state first
      const stateLoaded = loadState();
      
      // If no saved state, load default recipes
      if (!stateLoaded) {
        loadRecipes();
        updateShoppingList();
      }
      
      // Add event listeners for checkbox changes
      document.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox' && e.target.closest('.grocery-item')) {
          const item = e.target.parentElement;
          item.classList.toggle('checked', e.target.checked);
          
          // Handle hide/show logic
          if (hideCheckedItems && e.target.checked) {
            item.style.display = 'none';
          } else {
            item.style.display = 'flex';
          }
          
          saveState();
        }
      });
    });
    </script>


</body>
</html>
